<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Decrypto</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent; /* Remove blue highlight on tap for iOS */
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }

    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 2.5em;
    }

    h2 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.8em;
    }

    h3 {
      color: #764ba2;
      margin-bottom: 10px;
      font-size: 1.3em;
    }

    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
      margin-right: 10px;
      margin-top: 10px;
      min-height: 44px; /* iOS recommended minimum touch target */
      touch-action: manipulation; /* Disable double-tap zoom */
    }

    .btn:hover {
      background: #764ba2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .btn:disabled {
      background: #a0aec0;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: #48bb78;
    }

    .btn-secondary:hover {
      background: #38a169;
    }

    .btn-danger {
      background: #f56565;
    }

    .btn-danger:hover {
      background: #e53e3e;
    }

    .btn-large {
      font-size: 1.3em;
      padding: 20px 40px;
    }

    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      font-size: 16px; /* Prevents zoom on iOS */
      margin-bottom: 15px;
      transition: border 0.3s;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      -webkit-appearance: none; /* Remove iOS default styling */
      appearance: none;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }

    .team-a {
      background: #ebf8ff;
      border-left: 4px solid #3182ce;
    }

    .team-b {
      background: #fef5e7;
      border-left: 4px solid #dd6b20;
    }

    .words-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin: 20px 0;
    }

    .word-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .word-card .number {
      color: #667eea;
      font-size: 0.9em;
      margin-bottom: 5px;
    }

    .code-display {
      background: #fef5e7;
      border: 3px dashed #dd6b20;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      font-size: 3em;
      font-weight: bold;
      color: #dd6b20;
      letter-spacing: 20px;
      margin: 20px 0;
    }

    .clue-input-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 15px;
      align-items: center;
      margin: 10px 0;
    }

    .clue-label {
      font-weight: bold;
      color: #667eea;
      font-size: 1.2em;
    }

    .history-item {
      background: #f7fafc;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
      cursor: pointer;
      transition: all 0.3s;
    }

    .history-item:hover {
      background: #edf2f7;
      transform: translateX(5px);
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      color: #667eea;
    }

    .history-details {
      display: none;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid #e2e8f0;
    }

    .history-details.expanded {
      display: block;
    }

    .expand-icon {
      transition: transform 0.3s;
      font-size: 1.2em;
    }

    .expand-icon.rotated {
      transform: rotate(90deg);
    }

    .history-team-section {
      margin: 15px 0;
      padding: 15px;
      border-radius: 8px;
    }

    .history-team-section.team-a-bg {
      background: #ebf8ff;
    }

    .history-team-section.team-b-bg {
      background: #fef5e7;
    }

    .clue-tracker {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .clue-tracker-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-top: 15px;
    }

    .clue-column {
      background: #f7fafc;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #e2e8f0;
    }

    .clue-column-header {
      font-weight: bold;
      font-size: 1.3em;
      color: #667eea;
      text-align: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }

    .clue-entry {
      padding: 8px;
      margin: 5px 0;
      background: white;
      border-radius: 4px;
      font-size: 0.9em;
      border-left: 3px solid #667eea;
    }

    .clue-entry.round-highlight {
      background: #fff5cc;
      font-weight: bold;
      border-left-color: #f59e0b;
    }

    .clue-entry-round {
      font-size: 0.75em;
      color: #718096;
      margin-right: 5px;
    }

    .round-header {
      font-weight: bold;
      color: #667eea;
      margin-bottom: 8px;
    }

    .score-display {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .score-item {
      text-align: center;
      padding: 20px;
      background: #f7fafc;
      border-radius: 8px;
      flex: 1;
      margin: 10px;
      min-width: 150px;
    }

    .score-value {
      font-size: 3em;
      font-weight: bold;
      color: #667eea;
    }

    .score-label {
      font-size: 0.9em;
      color: #718096;
      margin-top: 5px;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .alert-success {
      background: #c6f6d5;
      color: #22543d;
      border-left: 4px solid #48bb78;
    }

    .alert-info {
      background: #bee3f8;
      color: #2c5282;
      border-left: 4px solid #3182ce;
    }

    .alert-warning {
      background: #fef5e7;
      color: #744210;
      border-left: 4px solid #dd6b20;
    }

    .game-over {
      text-align: center;
      padding: 40px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border-radius: 12px;
      font-size: 2em;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-connected {
      background: #48bb78;
    }

    .status-disconnected {
      background: #f56565;
    }

    .code-input-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 15px 0;
    }

    .code-input-group input {
      width: 60px;
      height: 60px;
      text-align: center;
      font-size: 2em;
      font-weight: bold;
      margin: 0;
    }

    .phase-indicator {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .results-card {
      background: #f7fafc;
      padding: 20px;
      border-radius: 8px;
      margin: 15px 0;
    }

    .result-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      border-radius: 6px;
    }

    .result-row.correct {
      background: #c6f6d5;
    }

    .result-row.incorrect {
      background: #fed7d7;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        max-width: 100%;
      }

      .card {
        padding: 15px;
        margin-bottom: 15px;
      }

      h1 {
        font-size: 1.8em;
        margin-bottom: 8px;
      }

      h2 {
        font-size: 1.3em;
        margin-bottom: 10px;
      }

      h3 {
        font-size: 1.1em;
      }

      .btn {
        padding: 10px 20px;
        font-size: 14px;
        margin-right: 5px;
        margin-top: 8px;
      }

      .btn-large {
        font-size: 1.1em;
        padding: 15px 30px;
      }

      input, select {
        padding: 10px;
        font-size: 14px;
        margin-bottom: 12px;
      }

      .words-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .word-card {
        padding: 12px;
        font-size: 1em;
      }

      .code-display {
        padding: 20px;
        font-size: 2em;
        letter-spacing: 10px;
      }

      .score-display {
        flex-direction: column;
        gap: 5px;
      }

      .score-item {
        margin: 5px 0;
        padding: 15px;
        min-width: auto;
      }

      .score-value {
        font-size: 2.5em;
      }

      .phase-indicator {
        padding: 15px;
        font-size: 1.1em;
      }

      .clue-input-grid {
        grid-template-columns: 1fr;
        gap: 5px;
      }

      .clue-label {
        font-size: 1em;
        margin-bottom: 5px;
      }

      .code-input-group input {
        width: 50px;
        height: 50px;
        font-size: 1.5em;
      }

      .clue-tracker-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .clue-column {
        padding: 10px;
      }

      .clue-column-header {
        font-size: 1.1em;
      }

      .clue-entry {
        padding: 6px;
        font-size: 0.85em;
      }

      .history-item {
        padding: 12px;
      }

      .history-team-section {
        padding: 12px;
        font-size: 0.9em;
      }

      .result-row {
        padding: 8px;
        font-size: 0.9em;
      }

      .game-over {
        padding: 25px;
        font-size: 1.5em;
      }

      .alert {
        padding: 12px;
        font-size: 0.9em;
      }

      /* Make player info wrap better on mobile */
      #playerInfo {
        font-size: 0.85em;
        word-break: break-all;
      }

      /* Better button layout on mobile */
      div[style*="display: flex"] {
        flex-direction: column;
        align-items: stretch !important;
      }

      /* Stack header elements on mobile */
      .card > div[style*="display: flex"]:first-of-type {
        flex-direction: column;
        align-items: flex-start !important;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.5em;
      }

      h2 {
        font-size: 1.2em;
      }

      .code-display {
        font-size: 1.5em;
        padding: 15px;
        letter-spacing: 8px;
      }

      .score-value {
        font-size: 2em;
      }

      .phase-indicator {
        font-size: 1em;
        padding: 12px;
      }

      .clue-tracker-grid {
        grid-template-columns: 1fr;
      }

      .words-grid {
        grid-template-columns: 1fr;
      }

      .btn {
        width: 100%;
        margin-right: 0;
      }

      .code-input-group {
        gap: 5px;
      }

      .code-input-group input {
        width: 45px;
        height: 45px;
        font-size: 1.3em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1 style="text-align: center;">üîê Decrypto</h1>
      <p style="color: #718096; margin-bottom: 20px; text-align: center;"><span id="connectionStatus"></span></p>
      
      <div id="setupScreen">
        <h2>Game Setup</h2>
        
        <div style="margin-bottom: 30px;">
          <h3>Create New Game</h3>
          <button class="btn" onclick="createGame()">Create New Game</button>
        </div>

        <div>
          <h3>Join Existing Game</h3>
          <input type="text" id="gameCodeInput" placeholder="Enter game code">
          <select id="teamSelect">
            <option value="">Select Team</option>
            <option value="A">Team A (Blue)</option>
            <option value="B">Team B (Orange)</option>
          </select>
          <p style="color: #718096; font-size: 0.9em; margin: 10px 0;">
            Note: You can take on either role (clue-giver or guesser) each round!
          </p>
          <button class="btn btn-secondary" onclick="joinGame()">Join Game</button>
        </div>
      </div>

      <div id="gameScreen" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
          <div style="flex: 1; min-width: 200px;">
            <h2 id="gameTitle">Game: <span id="gameCodeDisplay"></span></h2>
            <p id="playerInfo" style="color: #718096;"></p>
          </div>
          <div>
            <button class="btn btn-danger" onclick="leaveGame()">Leave Game</button>
          </div>
        </div>

        <div id="phaseIndicator" class="phase-indicator"></div>

        <div id="gameOverMessage" style="display: none;"></div>

        <div class="score-display">
          <div class="score-item team-a">
            <div class="score-value" id="teamAMiscomm">0</div>
            <div class="score-label">Team A Miscommunications</div>
          </div>
          <div class="score-item team-a">
            <div class="score-value" id="teamAInterceptions">0</div>
            <div class="score-label">Team A Interceptions</div>
          </div>
          <div class="score-item team-b">
            <div class="score-value" id="teamBMiscomm">0</div>
            <div class="score-label">Team B Miscommunications</div>
          </div>
          <div class="score-item team-b">
            <div class="score-value" id="teamBInterceptions">0</div>
            <div class="score-label">Team B Interceptions</div>
          </div>
        </div>

        <div id="myTeamSection"></div>
        <div id="actionSection"></div>
        <div id="clueTrackerSection"></div>
        <div id="historySection"></div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script>
    // Game Version
    const GAME_VERSION = "v3.0.0";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBQfDW3cv268JlQRL7UeFhphR76hAStmS0",
      authDomain: "mydecrypto-2cc47.firebaseapp.com",
      databaseURL: "https://mydecrypto-2cc47-default-rtdb.firebaseio.com",
      projectId: "mydecrypto-2cc47",
      storageBucket: "mydecrypto-2cc47.firebasestorage.app",
      messagingSenderId: "757533875276",
      appId: "1:757533875276:web:28d3a9c5b8a9f5d5ec68e9",
      measurementId: "G-K4P1KKFH89"
    };

    // Initialize Firebase
    let db = null;
    let isFirebaseConfigured = false;

    function updateConnectionStatus(connected) {
      const statusEl = document.getElementById('connectionStatus');
      const versionText = `<span style="margin-left: 15px; color: #718096;">| ${GAME_VERSION}</span>`;
      
      if (connected) {
        statusEl.innerHTML = '<span class="status-indicator status-connected"></span>Connected' + versionText;
      } else {
        statusEl.innerHTML = '<span class="status-indicator status-disconnected"></span>Not Connected' + versionText;
      }
    }

    function initializeFirebase() {
      if (typeof firebase === 'undefined') {
        updateConnectionStatus(false);
        return;
      }

      try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        
        db.ref('.info/connected').on('value', (snapshot) => {
          if (snapshot.val() === true) {
            isFirebaseConfigured = true;
            updateConnectionStatus(true);
          }
        });
      } catch (error) {
        console.error('Firebase error:', error);
        updateConnectionStatus(false);
      }
    }

    window.addEventListener('load', initializeFirebase);

    // Show version immediately
    document.addEventListener('DOMContentLoaded', () => {
      const statusEl = document.getElementById('connectionStatus');
      if (statusEl) {
        statusEl.innerHTML = '<span class="status-indicator status-disconnected"></span>Connecting... <span style="margin-left: 15px; color: #718096;">| ' + GAME_VERSION + '</span>';
      }
      
      // Check if player was already in a game (page refresh)
      const savedPlayerId = sessionStorage.getItem('decrypto_playerId');
      if (savedPlayerId) {
        myPlayerId = savedPlayerId;
        const savedGameCode = sessionStorage.getItem(`decrypto_${myPlayerId}_gameCode`);
        const savedTeam = sessionStorage.getItem(`decrypto_${myPlayerId}_team`);
        const savedRole = sessionStorage.getItem(`decrypto_${myPlayerId}_role`);
        
        if (savedGameCode && savedTeam && savedRole) {
          console.log('Restoring session:', { 
            playerId: myPlayerId, 
            gameCode: savedGameCode, 
            team: savedTeam, 
            role: savedRole 
          });
          
          // Restore player state
          gameCode = savedGameCode;
          myTeam = savedTeam;
          myRole = savedRole;
          
          // Auto-rejoin the game when Firebase connects
          setTimeout(() => {
            if (isFirebaseConfigured && gameCode) {
              gameRef = db.ref(`games/${gameCode}`);
              gameRef.once('value').then(snapshot => {
                if (snapshot.exists()) {
                  currentGame = snapshot.val();
                  
                  gameRef.on('value', (snapshot) => {
                    if (snapshot.exists()) {
                      currentGame = snapshot.val();
                      renderGame();
                    }
                  });
                  
                  document.getElementById('setupScreen').style.display = 'none';
                  document.getElementById('gameScreen').style.display = 'block';
                  renderGame();
                }
              });
            }
          }, 1000); // Wait for Firebase to connect
        }
      }
    });

    // Game state
    let currentGame = null;
    let myTeam = null;
    let myRole = null;
    let gameCode = null;
    let gameRef = null;
    let myPlayerId = null; // Unique ID for this player/tab

    function generatePlayerId() {
      // Generate a short, unique ID: timestamp + random 6-char string
      const timestamp = Date.now().toString(36); // Base36 is shorter
      const random = Math.random().toString(36).substring(2, 8);
      return `P${timestamp}${random}`;
    }

    function getOrCreatePlayerId() {
      let playerId = sessionStorage.getItem('decrypto_playerId');
      if (!playerId) {
        playerId = generatePlayerId();
        sessionStorage.setItem('decrypto_playerId', playerId);
      }
      return playerId;
    }

    const WORD_BANK = [
      // Original 64 words
      "PIANO", "THUNDER", "DIAMOND", "CASTLE", "ROBOT", "OCEAN", "ROCKET", "DRAGON",
      "MAGIC", "FOREST", "CLOCK", "MIRROR", "BOOK", "STAR", "MOON", "FIRE",
      "WATER", "EARTH", "WIND", "MOUNTAIN", "RIVER", "BRIDGE", "TOWER", "CROWN",
      "SWORD", "SHIELD", "ARROW", "GATE", "WALL", "PATH", "ROAD", "SHIP",
      "COIN", "RING", "KEY", "LOCK", "DOOR", "WINDOW", "LIGHT", "SHADOW",
      "CLOUD", "RAIN", "SNOW", "SUN", "NIGHT", "DAY", "TIME", "SPACE",
      "HEART", "MIND", "SOUL", "DREAM", "HOPE", "FEAR", "JOY", "PEACE",
      "WAR", "KING", "QUEEN", "KNIGHT", "ANGEL", "DEMON", "GHOST", "SPIRIT",
      // Additional 56 words (Total: 120)
      "ANCHOR", "APPLE", "BALLOON", "BEACH", "BEAR", "BIRD", "BOTTLE", "BUTTER",
      "CAMERA", "CANDLE", "CHAIR", "CHEESE", "CIRCLE", "COFFEE", "COMPASS", "CRYSTAL",
      "DANCE", "DESERT", "EAGLE", "ENGINE", "FEATHER", "FLAME", "FLOWER", "FOUNTAIN",
      "GALAXY", "GARDEN", "GIANT", "GOLD", "GUITAR", "HAMMER", "HONEY", "HORSE",
      "ICE", "ISLAND", "JEWEL", "JUNGLE", "LADDER", "LAMP", "LEAF", "LIGHTNING",
      "MARBLE", "MASK", "METAL", "MUSIC", "NEEDLE", "PAINT", "PAPER", "PEARL",
      "PHOENIX", "PLANET", "PYRAMID", "RAINBOW", "RUBY", "SILVER", "SMOKE", "SNAKE"
    ];

    function generateGameCode() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function getRandomWords(count) {
      const shuffled = [...WORD_BANK].sort(() => Math.random() - 0.5);
      return shuffled.slice(0, count);
    }

    function generateCode() {
      const numbers = [1, 2, 3, 4];
      const shuffled = numbers.sort(() => Math.random() - 0.5);
      return shuffled.slice(0, 3); // Take first 3 numbers, guarantees no repeats
    }

    function generateUniqueCode() {
      if (!currentGame.usedCodes) {
        currentGame.usedCodes = [];
      }

      let attempts = 0;
      const maxAttempts = 100;
      
      while (attempts < maxAttempts) {
        const code = generateCode();
        const codeStr = JSON.stringify(code);
        
        // Check if this code has been used before
        if (!currentGame.usedCodes.includes(codeStr)) {
          currentGame.usedCodes.push(codeStr);
          return code;
        }
        
        attempts++;
      }
      
      // Fallback if somehow we can't find a unique code (very unlikely)
      return generateCode();
    }

    async function createGame() {
      if (!isFirebaseConfigured) {
        alert('Firebase is not connected yet.');
        return;
      }

      gameCode = generateGameCode();
      
      const newGame = {
        code: gameCode,
        teamA: {
          words: getRandomWords(4),
          score: { miscommunications: 0, interceptions: 0 }
        },
        teamB: {
          words: getRandomWords(4),
          score: { miscommunications: 0, interceptions: 0 }
        },
        rounds: [],
        currentRound: 1,
        maxRounds: 8,
        usedCodes: [], // Track codes already used
        phase: 'clues', // clues, guessing, results
        roundData: {
          A: { code: null, clues: null, guess: null, interception: null, clueGiverClaimed: false },
          B: { code: null, clues: null, guess: null, interception: null, clueGiverClaimed: false }
        },
        gameOver: false,
        winner: null
      };

      try {
        await db.ref(`games/${gameCode}`).set(newGame);
        
        const setupScreen = document.getElementById('setupScreen');
        setupScreen.innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <h2 style="color: #48bb78; margin-bottom: 20px;">‚úì Game Created!</h2>
            <div style="background: #c6f6d5; padding: 30px; border-radius: 12px; margin: 20px 0;">
              <p style="font-size: 1.2em; margin-bottom: 10px; color: #22543d;">Share this code:</p>
              <div style="font-size: 3em; font-weight: bold; color: #22543d; letter-spacing: 8px;">${gameCode}</div>
            </div>
            <input type="text" id="gameCodeInput" value="${gameCode}" readonly style="background: #f7fafc;">
            <select id="teamSelect">
              <option value="">Select Team</option>
              <option value="A">Team A (Blue)</option>
              <option value="B">Team B (Orange)</option>
            </select>
            <select id="roleSelect">
              <option value="">Select Role</option>
              <option value="guesser">Guesser</option>
              <option value="cluegiver">Clue-Giver</option>
            </select>
            <button class="btn btn-secondary" onclick="joinGame()">Join Game</button>
          </div>
        `;
      } catch (error) {
        console.error('Error creating game:', error);
        alert('Error creating game: ' + error.message);
      }
    }

    async function joinGame() {
      if (!isFirebaseConfigured) {
        alert('Firebase is not connected yet.');
        return;
      }

      const code = document.getElementById('gameCodeInput').value.trim().toUpperCase();
      const team = document.getElementById('teamSelect').value;

      if (!code || !team) {
        alert('Please enter game code and select your team');
        return;
      }

      try {
        // Get or create unique player ID
        myPlayerId = getOrCreatePlayerId();
        
        gameCode = code;
        myTeam = team;
        myRole = 'flexible'; // Role is now determined by actions each round
        
        console.log('Joining game as:', { playerId: myPlayerId, team: myTeam, role: 'flexible' });
        
        // Store player identity in sessionStorage (per browser tab)
        sessionStorage.setItem(`decrypto_${myPlayerId}_gameCode`, gameCode);
        sessionStorage.setItem(`decrypto_${myPlayerId}_team`, myTeam);
        sessionStorage.setItem(`decrypto_${myPlayerId}_role`, myRole);
        
        gameRef = db.ref(`games/${gameCode}`);

        const snapshot = await gameRef.once('value');
        if (!snapshot.exists()) {
          alert('Game not found!');
          return;
        }

        currentGame = snapshot.val();

        gameRef.on('value', (snapshot) => {
          if (snapshot.exists()) {
            currentGame = snapshot.val();
            renderGame();
          }
        });

        document.getElementById('setupScreen').style.display = 'none';
        document.getElementById('gameScreen').style.display = 'block';
        
        renderGame();
      } catch (error) {
        console.error('Error joining game:', error);
        alert('Error joining game: ' + error.message);
      }
    }

    function leaveGame() {
      if (confirm('Are you sure you want to leave?')) {
        if (gameRef) gameRef.off();
        
        // Clear session storage for this player
        if (myPlayerId) {
          sessionStorage.removeItem(`decrypto_${myPlayerId}_gameCode`);
          sessionStorage.removeItem(`decrypto_${myPlayerId}_team`);
          sessionStorage.removeItem(`decrypto_${myPlayerId}_role`);
          sessionStorage.removeItem('decrypto_playerId');
        }
        
        location.reload();
      }
    }

    function renderGame() {
      if (!currentGame) return;

      document.getElementById('gameCodeDisplay').textContent = gameCode;
      document.getElementById('playerInfo').textContent = 
        `You are: Team ${myTeam} | Round ${currentGame.currentRound} | Player ID: ${myPlayerId || 'Unknown'}`;

      document.getElementById('teamAMiscomm').textContent = currentGame.teamA?.score?.miscommunications || 0;
      document.getElementById('teamBMiscomm').textContent = currentGame.teamB?.score?.miscommunications || 0;
      document.getElementById('teamAInterceptions').textContent = currentGame.teamA?.score?.interceptions || 0;
      document.getElementById('teamBInterceptions').textContent = currentGame.teamB?.score?.interceptions || 0;

      if (currentGame.gameOver) {
        document.getElementById('gameOverMessage').style.display = 'block';
        document.getElementById('gameOverMessage').innerHTML = `
          <div class="game-over">
            üéâ Game Over! ${currentGame.winner} wins! üéâ
          </div>
        `;
      }

      renderPhaseIndicator();
      renderMyTeamSection();
      renderActionSection();
      
      // Render clue tracker
      const clueTrackerHtml = renderClueTracker();
      document.getElementById('clueTrackerSection').innerHTML = clueTrackerHtml;
      
      renderHistory();
    }

    function renderPhaseIndicator() {
      const phase = currentGame.phase;
      const maxRounds = currentGame.maxRounds || 8;
      let phaseText = '';
      
      if (phase === 'clues') {
        phaseText = `üìù Round ${currentGame.currentRound}/${maxRounds} - Phase 1: Clue-Givers`;
      } else if (phase === 'guessing') {
        phaseText = `üéØ Round ${currentGame.currentRound}/${maxRounds} - Phase 2: Guessing & Interception`;
      } else if (phase === 'results') {
        phaseText = `üìä Round ${currentGame.currentRound}/${maxRounds} - Phase 3: Results`;
      }
      
      document.getElementById('phaseIndicator').textContent = phaseText;
    }

    function renderMyTeamSection() {
      if (!currentGame) return;

      const myTeamData = myTeam === 'A' ? currentGame.teamA : currentGame.teamB;
      if (!myTeamData?.words) return;

      const teamClass = myTeam === 'A' ? 'team-a' : 'team-b';
      
      const html = `
        <div class="card ${teamClass}">
          <h2>Your Team (Team ${myTeam}) - Secret Words</h2>
          <div class="words-grid">
            ${myTeamData.words.map((word, idx) => `
              <div class="word-card">
                <div class="number">#${idx + 1}</div>
                <div>${word}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      
      document.getElementById('myTeamSection').innerHTML = html;
    }

    function renderActionSection() {
      if (!currentGame) return;

      const phase = currentGame.phase;
      const myTeamKey = myTeam;
      const opponentTeam = myTeam === 'A' ? 'B' : 'A';
      const opponentTeamKey = opponentTeam;
      const myTeamRoundData = currentGame.roundData?.[myTeamKey] || {};
      const opponentRoundData = currentGame.roundData?.[opponentTeamKey] || {};

      let html = '<div class="card">';

      if (currentGame.gameOver) {
        html += '<p style="text-align: center; font-size: 1.2em;">Game is over!</p>';
      } else if (phase === 'clues' && myRole === 'cluegiver') {
        // Clue-giving phase - now with claiming system
        const isClaimed = myTeamRoundData.clueGiverClaimed;
        
        if (!myTeamRoundData.clues) {
          if (!isClaimed) {
            // Show claim button - anyone on the team can claim
            html += `
              <h2>Clue-Giver Role Available</h2>
              <div class="alert alert-info">
                <strong>Ready to give clues this round?</strong><br>
                Click below to claim the clue-giver role for Round ${currentGame.currentRound}.
              </div>
              <button class="btn btn-large btn-secondary" onclick="claimClueGiverRole()">
                üôã I'll Give Clues This Round!
              </button>
              <p style="margin-top: 15px; color: #718096; text-align: center;">
                Waiting for someone on your team to claim the role...
              </p>
            `;
          } else {
            // Role claimed, show clue input
            const code = myTeamRoundData.code || generateUniqueCode();
            html += `
              <h2>Give Your Clues</h2>
              <div class="alert alert-success" style="margin-bottom: 15px;">
                ‚úì You claimed the clue-giver role for this round!
              </div>
              <div class="code-display">${code.join(' ')}</div>
              <p style="margin-bottom: 15px;">Give one clue for each number:</p>
              ${code.map((num, idx) => `
                <div class="clue-input-grid">
                  <div class="clue-label">Clue for #${num}:</div>
                  <input type="text" id="clue${idx}" placeholder="Enter clue">
                </div>
              `).join('')}
              <button class="btn btn-large" onclick="submitClues([${code}])">Submit Clues</button>
            `;
          }
        } else {
          html += `
            <div class="alert alert-success">
              <strong>‚úì Your clues submitted!</strong><br>
              Waiting for other clue-giver...
            </div>
          `;
        }

        // Show opponent's clues if they've submitted
        if (opponentRoundData.clues) {
          html += `
            <hr style="margin: 30px 0; border: 1px solid #e2e8f0;">
            <h3>Team ${opponentTeam} Clues (Submitted)</h3>
            <div class="alert alert-info">
              Clue 1: ${opponentRoundData.clues[0]}<br>
              Clue 2: ${opponentRoundData.clues[1]}<br>
              Clue 3: ${opponentRoundData.clues[2]}
            </div>
          `;
        } else {
          html += `
            <hr style="margin: 30px 0; border: 1px solid #e2e8f0;">
            <p style="text-align: center; color: #718096;">Team ${opponentTeam} hasn't submitted clues yet...</p>
          `;
        }
      } else if (phase === 'clues' && myRole === 'guesser') {
        // Guessers wait during clue-giving phase, but can see submitted clues
        html += '<h2>Clue-Givers Are Working...</h2>';
        
        if (myTeamRoundData.clues) {
          html += `
            <div class="alert alert-success">
              <strong>‚úì Your clue-giver submitted clues!</strong><br>
              ${myTeamRoundData.clues.map((c, i) => `Clue ${i+1}: ${c}`).join('<br>')}
            </div>
          `;
        } else {
          html += `
            <div class="alert alert-warning">
              Waiting for your clue-giver to submit clues...
            </div>
          `;
        }

        if (opponentRoundData.clues) {
          html += `
            <hr style="margin: 30px 0; border: 1px solid #e2e8f0;">
            <h3>Team ${opponentTeam} Clues (Submitted)</h3>
            <div class="alert alert-info">
              Clue 1: ${opponentRoundData.clues[0]}<br>
              Clue 2: ${opponentRoundData.clues[1]}<br>
              Clue 3: ${opponentRoundData.clues[2]}
            </div>
          `;
        } else {
          html += `
            <hr style="margin: 30px 0; border: 1px solid #e2e8f0;">
            <p style="text-align: center; color: #718096;">Team ${opponentTeam} clue-giver hasn't submitted yet...</p>
          `;
        }
      } else if (phase === 'clues' && myRole === 'cluegiver') {
        // Clue-givers in waiting state
        html += '<h2>Waiting...</h2>';
        if (myTeamRoundData.clues) {
          html += `<div class="alert alert-success">‚úì Your clues submitted! Waiting for other clue-giver...</div>`;
        } else {
          html += `<div class="alert alert-warning">Something went wrong. Please refresh.</div>`;
        }
      } else if (phase === 'guessing' && myRole === 'cluegiver') {
        // Clue-givers wait during guessing phase
        html += '<h2>Guessers Are Working...</h2>';
        html += '<div class="alert alert-info">';
        html += '<strong>Status:</strong><br>';
        html += `Team A Guess: ${currentGame.roundData.A.guess ? '‚úì Submitted' : '‚è≥ Pending'}<br>`;
        html += `Team A Interception: ${currentGame.roundData.A.interception ? '‚úì Submitted' : '‚è≥ Pending'}<br>`;
        html += `Team B Guess: ${currentGame.roundData.B.guess ? '‚úì Submitted' : '‚è≥ Pending'}<br>`;
        html += `Team B Interception: ${currentGame.roundData.B.interception ? '‚úì Submitted' : '‚è≥ Pending'}`;
        html += '</div>';
        html += '<p style="margin-top: 15px; text-align: center; color: #718096;">Please wait while teams complete their guesses and interception attempts...</p>';
      } else if (phase === 'guessing' && myRole === 'guesser') {
        // Guessing & interception phase
        html += '<h2>Guessing Phase</h2>';
        
        // Show status of both teams
        html += '<div class="alert alert-info" style="margin-bottom: 20px;">';
        html += '<strong>Status:</strong><br>';
        html += `Team A Guess: ${currentGame.roundData.A.guess ? '‚úì Submitted' : '‚è≥ Pending'}<br>`;
        html += `Team A Interception: ${currentGame.roundData.A.interception ? '‚úì Submitted' : '‚è≥ Pending'}<br>`;
        html += `Team B Guess: ${currentGame.roundData.B.guess ? '‚úì Submitted' : '‚è≥ Pending'}<br>`;
        html += `Team B Interception: ${currentGame.roundData.B.interception ? '‚úì Submitted' : '‚è≥ Pending'}`;
        html += '</div>';
        
        // Guess your own team's code
        if (myTeamRoundData.clues && !myTeamRoundData.guess) {
          html += `
            <div class="alert alert-info">
              <strong>Your Team's Clues:</strong><br>
              ${myTeamRoundData.clues.map((c, i) => `Clue ${i+1}: ${c}`).join('<br>')}
            </div>
            <p style="margin: 15px 0;">Guess your team's code:</p>
            <div class="code-input-group">
              <input type="number" id="guess0" min="1" max="4">
              <input type="number" id="guess1" min="1" max="4">
              <input type="number" id="guess2" min="1" max="4">
            </div>
            <button class="btn" onclick="submitGuess()">Submit Guess</button>
          `;
        } else if (myTeamRoundData.guess) {
          html += `<div class="alert alert-success">‚úì Your guess submitted!</div>`;
        }

        // Intercept opponent's code
        if (opponentRoundData.clues && !myTeamRoundData.interception) {
          html += `
            <hr style="margin: 30px 0;">
            <div class="alert alert-warning">
              <strong>Opponent's Clues:</strong><br>
              ${opponentRoundData.clues.map((c, i) => `Clue ${i+1}: ${c}`).join('<br>')}
            </div>
            <p style="margin: 15px 0;">Try to intercept their code:</p>
            <div class="code-input-group">
              <input type="number" id="intercept0" min="1" max="4">
              <input type="number" id="intercept1" min="1" max="4">
              <input type="number" id="intercept2" min="1" max="4">
            </div>
            <button class="btn" onclick="submitInterception()">Attempt Interception</button>
            <button class="btn btn-secondary" onclick="skipInterception()">Skip</button>
          `;
        } else if (myTeamRoundData.interception) {
          html += `<div class="alert alert-success">‚úì Interception submitted!</div>`;
        }
      } else if (phase === 'results') {
        // Results phase - EVERYONE can see this (both clue-givers and guessers)
        html += '<h2>üìä Round ' + currentGame.currentRound + ' Results</h2>';
        html += '<div class="results-card">';
        
        // Team A results
        const teamAData = currentGame.roundData.A;
        const teamACorrect = JSON.stringify(teamAData.guess) === JSON.stringify(teamAData.code);
        const teamBInterceptedA = JSON.stringify(currentGame.roundData.B.interception) === JSON.stringify(teamAData.code);
        
        html += `<h3 style="color: #3182ce;">Team A (Blue)</h3>`;
        html += `<div class="result-row" style="background: #e6f2ff;"><strong>Secret Code:</strong> <span style="font-size: 1.5em; color: #3182ce;">${teamAData.code.join(' ')}</span></div>`;
        html += `<div class="result-row ${teamACorrect ? 'correct' : 'incorrect'}">
          <strong>Team A Guess:</strong> ${teamAData.guess.join(' ')} ${teamACorrect ? '‚úì CORRECT' : '‚úó WRONG = Miscommunication!'}
        </div>`;
        if (currentGame.roundData.B.interception && currentGame.roundData.B.interception.join('') !== '000') {
          html += `<div class="result-row ${teamBInterceptedA ? 'incorrect' : 'correct'}">
            <strong>Team B Interception:</strong> ${currentGame.roundData.B.interception.join(' ')} ${teamBInterceptedA ? '‚úì SUCCESS! (Interception point)' : '‚úó Failed'}
          </div>`;
        } else {
          html += `<div class="result-row"><strong>Team B Interception:</strong> Skipped</div>`;
        }
        
        // Team B results
        const teamBData = currentGame.roundData.B;
        const teamBCorrect = JSON.stringify(teamBData.guess) === JSON.stringify(teamBData.code);
        const teamAInterceptedB = JSON.stringify(currentGame.roundData.A.interception) === JSON.stringify(teamBData.code);
        
        html += `<h3 style="margin-top: 30px; color: #dd6b20;">Team B (Orange)</h3>`;
        html += `<div class="result-row" style="background: #fef5e7;"><strong>Secret Code:</strong> <span style="font-size: 1.5em; color: #dd6b20;">${teamBData.code.join(' ')}</span></div>`;
        html += `<div class="result-row ${teamBCorrect ? 'correct' : 'incorrect'}">
          <strong>Team B Guess:</strong> ${teamBData.guess.join(' ')} ${teamBCorrect ? '‚úì CORRECT' : '‚úó WRONG = Miscommunication!'}
        </div>`;
        if (currentGame.roundData.A.interception && currentGame.roundData.A.interception.join('') !== '000') {
          html += `<div class="result-row ${teamAInterceptedB ? 'incorrect' : 'correct'}">
            <strong>Team A Interception:</strong> ${currentGame.roundData.A.interception.join(' ')} ${teamAInterceptedB ? '‚úì SUCCESS! (Interception point)' : '‚úó Failed'}
          </div>`;
        } else {
          html += `<div class="result-row"><strong>Team A Interception:</strong> Skipped</div>`;
        }
        
        html += '</div>';
        html += '<div style="text-align: center; margin-top: 30px;">';
        html += '<button class="btn btn-large" onclick="nextRound()">Continue to Round ' + (currentGame.currentRound + 1) + ' ‚Üí</button>';
        html += '</div>';
      } else {
        html += '<p style="text-align: center;">Waiting for your turn...</p>';
      }

      html += '</div>';
      document.getElementById('actionSection').innerHTML = html;
    }

    async function submitClues(code) {
      const clues = [
        document.getElementById('clue0').value.trim(),
        document.getElementById('clue1').value.trim(),
        document.getElementById('clue2').value.trim()
      ];

      if (clues.some(c => !c)) {
        alert('Please enter all three clues');
        return;
      }

      // Safety check: ensure roundData exists
      if (!currentGame.roundData) {
        console.warn('roundData was undefined, reinitializing...');
        currentGame.roundData = {
          A: { code: null, clues: null, guess: null, interception: null, clueGiverClaimed: false },
          B: { code: null, clues: null, guess: null, interception: null, clueGiverClaimed: false }
        };
      }

      // Ensure team's roundData exists
      if (!currentGame.roundData[myTeam]) {
        currentGame.roundData[myTeam] = { code: null, clues: null, guess: null, interception: null, clueGiverClaimed: false };
      }

      currentGame.roundData[myTeam].code = code;
      currentGame.roundData[myTeam].clues = clues;

      // Check if both teams submitted clues
      if (currentGame.roundData.A?.clues && currentGame.roundData.B?.clues) {
        currentGame.phase = 'guessing';
      }

      try {
        await gameRef.set(currentGame);
        console.log('Clues submitted successfully');
      } catch (error) {
        console.error('Error submitting clues:', error);
        alert('Error submitting clues: ' + error.message);
      }
    }

    async function claimClueGiverRole() {
      // Safety check
      if (!currentGame.roundData || !currentGame.roundData[myTeam]) {
        alert('Error: Game data is corrupt. Please refresh.');
        return;
      }

      // Check if already claimed by someone
      if (currentGame.roundData[myTeam].clueGiverClaimed) {
        alert('Someone else already claimed the clue-giver role for this round!');
        return;
      }

      // Claim the role
      currentGame.roundData[myTeam].clueGiverClaimed = true;

      try {
        await gameRef.set(currentGame);
        console.log('Clue-giver role claimed');
        renderGame(); // Immediately show the clue input form
      } catch (error) {
        console.error('Error claiming role:', error);
        alert('Error claiming role: ' + error.message);
      }
    }

    async function submitGuess() {
      const guess = [
        parseInt(document.getElementById('guess0').value),
        parseInt(document.getElementById('guess1').value),
        parseInt(document.getElementById('guess2').value)
      ];

      if (guess.some(g => !g || g < 1 || g > 4)) {
        alert('Please enter valid numbers (1-4)');
        return;
      }

      // Check for duplicate numbers
      const uniqueNumbers = new Set(guess);
      if (uniqueNumbers.size !== guess.length) {
        alert('Error: You cannot use the same number twice!\nEach number (1-4) can only appear once in your guess.');
        return;
      }

      // Safety check
      if (!currentGame.roundData || !currentGame.roundData[myTeam]) {
        alert('Error: Game data is corrupt. Please refresh.');
        return;
      }

      currentGame.roundData[myTeam].guess = guess;
      
      // Check if guess is correct and show immediate feedback
      const code = currentGame.roundData[myTeam].code;
      const correct = JSON.stringify(guess) === JSON.stringify(code);
      
      if (correct) {
        alert('‚úì Correct! Your guess matches the code: ' + code.join(' '));
      } else {
        alert('Your guess submitted: ' + guess.join(' ') + '\n(Results will be revealed at the end of the round)');
      }

      checkPhaseComplete();

      try {
        await gameRef.set(currentGame);
        // Immediately re-render to hide the form
        renderGame();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function submitInterception() {
      const interception = [
        parseInt(document.getElementById('intercept0').value),
        parseInt(document.getElementById('intercept1').value),
        parseInt(document.getElementById('intercept2').value)
      ];

      if (interception.some(g => !g || g < 1 || g > 4)) {
        alert('Please enter valid numbers (1-4)');
        return;
      }

      // Check for duplicate numbers
      const uniqueNumbers = new Set(interception);
      if (uniqueNumbers.size !== interception.length) {
        alert('Error: You cannot use the same number twice!\nEach number (1-4) can only appear once in your interception.');
        return;
      }

      // Safety check
      if (!currentGame.roundData || !currentGame.roundData[myTeam]) {
        alert('Error: Game data is corrupt. Please refresh.');
        return;
      }

      currentGame.roundData[myTeam].interception = interception;
      
      // Check if interception is correct and show immediate feedback
      const opponentTeam = myTeam === 'A' ? 'B' : 'A';
      const opponentCode = currentGame.roundData[opponentTeam].code;
      const correct = JSON.stringify(interception) === JSON.stringify(opponentCode);
      
      if (correct) {
        alert('üéØ Interception SUCCESS! You cracked their code: ' + opponentCode.join(' '));
      } else {
        alert('Interception submitted: ' + interception.join(' ') + '\n(Results will be revealed at the end of the round)');
      }

      checkPhaseComplete();

      try {
        await gameRef.set(currentGame);
        // Immediately re-render to hide the form
        renderGame();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function skipInterception() {
      // Safety check
      if (!currentGame.roundData || !currentGame.roundData[myTeam]) {
        alert('Error: Game data is corrupt. Please refresh.');
        return;
      }

      currentGame.roundData[myTeam].interception = [0, 0, 0]; // Dummy value

      checkPhaseComplete();

      try {
        await gameRef.set(currentGame);
        // Immediately re-render to hide the form
        renderGame();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function checkPhaseComplete() {
      // Safety check
      if (!currentGame.roundData || !currentGame.roundData.A || !currentGame.roundData.B) {
        console.error('roundData structure invalid');
        return;
      }

      console.log('=== CHECK PHASE COMPLETE ===');
      console.log('Team A data:', {
        hasGuess: !!currentGame.roundData.A.guess,
        hasInterception: !!currentGame.roundData.A.interception
      });
      console.log('Team B data:', {
        hasGuess: !!currentGame.roundData.B.guess,
        hasInterception: !!currentGame.roundData.B.interception
      });

      // Check if both teams guessed and attempted interception
      if (currentGame.roundData.A.guess && currentGame.roundData.B.guess &&
          currentGame.roundData.A.interception && currentGame.roundData.B.interception) {
        
        console.log('‚úì All actions complete, calculating results...');
        
        // Calculate results
        const teamACorrect = JSON.stringify(currentGame.roundData.A.guess) === JSON.stringify(currentGame.roundData.A.code);
        const teamBCorrect = JSON.stringify(currentGame.roundData.B.guess) === JSON.stringify(currentGame.roundData.B.code);
        const teamAIntercepted = JSON.stringify(currentGame.roundData.A.interception) === JSON.stringify(currentGame.roundData.B.code);
        const teamBIntercepted = JSON.stringify(currentGame.roundData.B.interception) === JSON.stringify(currentGame.roundData.A.code);

        console.log('Results calculated:', {
          teamACorrect,
          teamBCorrect,
          teamAIntercepted,
          teamBIntercepted
        });

        // Ensure score objects exist
        if (!currentGame.teamA.score) {
          currentGame.teamA.score = { miscommunications: 0, interceptions: 0 };
        }
        if (!currentGame.teamB.score) {
          currentGame.teamB.score = { miscommunications: 0, interceptions: 0 };
        }

        // Update scores
        if (!teamACorrect) currentGame.teamA.score.miscommunications++;
        if (!teamBCorrect) currentGame.teamB.score.miscommunications++;
        if (teamBIntercepted) currentGame.teamB.score.interceptions++;
        if (teamAIntercepted) currentGame.teamA.score.interceptions++;

        // Check win conditions
        const teamALost = currentGame.teamA.score.miscommunications >= 2;
        const teamBLost = currentGame.teamB.score.miscommunications >= 2;
        const teamAWonByInterception = currentGame.teamA.score.interceptions >= 2;
        const teamBWonByInterception = currentGame.teamB.score.interceptions >= 2;

        if (teamALost && teamBLost) {
          // Both teams hit 2 miscommunications in same round - tie game!
          currentGame.gameOver = true;
          currentGame.winner = 'TIE - Both teams reached 2 miscommunications!';
        } else if (teamAWonByInterception && teamBWonByInterception) {
          // Both teams got 2 interceptions in same round - tie game!
          currentGame.gameOver = true;
          currentGame.winner = 'TIE - Both teams got 2 successful interceptions!';
        } else if (teamBLost) {
          currentGame.gameOver = true;
          currentGame.winner = 'Team A (Blue) wins - Team B had 2 miscommunications!';
        } else if (teamALost) {
          currentGame.gameOver = true;
          currentGame.winner = 'Team B (Orange) wins - Team A had 2 miscommunications!';
        } else if (teamAWonByInterception) {
          currentGame.gameOver = true;
          currentGame.winner = 'Team A (Blue) wins - 2 successful interceptions!';
        } else if (teamBWonByInterception) {
          currentGame.gameOver = true;
          currentGame.winner = 'Team B (Orange) wins - 2 successful interceptions!';
        }

        // Save round to history
        if (!currentGame.rounds) {
          console.warn('rounds array was undefined, initializing...');
          currentGame.rounds = [];
        }
        
        currentGame.rounds.push({
          round: currentGame.currentRound,
          teamA: { ...currentGame.roundData.A },
          teamB: { ...currentGame.roundData.B }
        });

        currentGame.phase = 'results';
        console.log('Phase changed to results');
        console.log('=== PHASE COMPLETE ===');
      } else {
        console.log('‚ùå Not all actions complete yet');
        console.log('=== PHASE CHECK END ===');
      }
    }

    async function nextRound() {
      // Check if max rounds reached
      if (currentGame.currentRound >= currentGame.maxRounds) {
        currentGame.gameOver = true;
        
        const teamAMiscomm = currentGame.teamA.score.miscommunications;
        const teamBMiscomm = currentGame.teamB.score.miscommunications;
        const teamAInterceptions = currentGame.teamA.score.interceptions;
        const teamBInterceptions = currentGame.teamB.score.interceptions;
        
        // Determine winner: Fewest miscommunications wins
        // If tied on miscommunications, most interceptions wins
        // If still tied, it's a tie game
        
        if (teamAMiscomm < teamBMiscomm) {
          currentGame.winner = `Team A (Blue) Wins! (${teamAMiscomm} miscommunications vs ${teamBMiscomm})`;
        } else if (teamBMiscomm < teamAMiscomm) {
          currentGame.winner = `Team B (Orange) Wins! (${teamBMiscomm} miscommunications vs ${teamAMiscomm})`;
        } else {
          // Tied on miscommunications, check interceptions
          if (teamAInterceptions > teamBInterceptions) {
            currentGame.winner = `Team A (Blue) Wins! (Tied ${teamAMiscomm}-${teamBMiscomm}, but ${teamAInterceptions} interceptions vs ${teamBInterceptions})`;
          } else if (teamBInterceptions > teamAInterceptions) {
            currentGame.winner = `Team B (Orange) Wins! (Tied ${teamAMiscomm}-${teamBMiscomm}, but ${teamBInterceptions} interceptions vs ${teamAInterceptions})`;
          } else {
            currentGame.winner = `Perfect Tie! Both teams: ${teamAMiscomm} miscommunications, ${teamAInterceptions} interceptions`;
          }
        }
        
        try {
          await gameRef.set(currentGame);
        } catch (error) {
          console.error('Error:', error);
        }
        return;
      }

      currentGame.currentRound++;
      currentGame.phase = 'clues';
      currentGame.roundData = {
        A: { code: null, clues: null, guess: null, interception: null, clueGiverClaimed: false },
        B: { code: null, clues: null, guess: null, interception: null, clueGiverClaimed: false }
      };

      try {
        await gameRef.set(currentGame);
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function renderHistory() {
      if (!currentGame?.rounds || currentGame.rounds.length === 0) {
        document.getElementById('historySection').innerHTML = '';
        return;
      }

      let html = '<div class="card"><h2>Game History</h2>';

      currentGame.rounds.forEach((round, index) => {
        const roundNum = round.round || (index + 1);
        const teamAData = round.teamA;
        const teamBData = round.teamB;
        
        if (!teamAData || !teamBData) return;
        
        // Calculate results
        const teamACorrect = JSON.stringify(teamAData.guess) === JSON.stringify(teamAData.code);
        const teamBCorrect = JSON.stringify(teamBData.guess) === JSON.stringify(teamBData.code);
        const teamAIntercepted = JSON.stringify(teamAData.interception) === JSON.stringify(teamBData.code);
        const teamBIntercepted = JSON.stringify(teamBData.interception) === JSON.stringify(teamAData.code);
        
        html += `
          <div class="history-item" onclick="toggleHistoryItem(${index})">
            <div class="history-header">
              <span>Round ${roundNum}</span>
              <span class="expand-icon" id="icon-${index}">‚ñ∂</span>
            </div>
            <div class="history-details" id="details-${index}">
              
              <div class="history-team-section team-a-bg">
                <h3 style="color: #3182ce; margin-bottom: 10px;">Team A (Blue)</h3>
                <div><strong>Secret Code:</strong> <span style="font-size: 1.3em; color: #3182ce;">${teamAData.code.join(' ')}</span></div>
                <div style="margin-top: 8px;"><strong>Clues:</strong> ${teamAData.clues.join(' | ')}</div>
                <div style="margin-top: 8px;">
                  <strong>Team A Guess:</strong> ${teamAData.guess.join(' ')} 
                  <span style="color: ${teamACorrect ? '#38a169' : '#e53e3e'}; font-weight: bold;">
                    ${teamACorrect ? '‚úì CORRECT' : '‚úó Miscommunication'}
                  </span>
                </div>
                ${teamBData.interception && teamBData.interception.join('') !== '000' ? `
                  <div style="margin-top: 8px;">
                    <strong>Team B Interception:</strong> ${teamBData.interception.join(' ')} 
                    <span style="color: ${teamBIntercepted ? '#e53e3e' : '#38a169'}; font-weight: bold;">
                      ${teamBIntercepted ? '‚úì Success!' : '‚úó Failed'}
                    </span>
                  </div>
                ` : '<div style="margin-top: 8px;"><strong>Team B Interception:</strong> Skipped</div>'}
              </div>

              <div class="history-team-section team-b-bg">
                <h3 style="color: #dd6b20; margin-bottom: 10px;">Team B (Orange)</h3>
                <div><strong>Secret Code:</strong> <span style="font-size: 1.3em; color: #dd6b20;">${teamBData.code.join(' ')}</span></div>
                <div style="margin-top: 8px;"><strong>Clues:</strong> ${teamBData.clues.join(' | ')}</div>
                <div style="margin-top: 8px;">
                  <strong>Team B Guess:</strong> ${teamBData.guess.join(' ')} 
                  <span style="color: ${teamBCorrect ? '#38a169' : '#e53e3e'}; font-weight: bold;">
                    ${teamBCorrect ? '‚úì CORRECT' : '‚úó Miscommunication'}
                  </span>
                </div>
                ${teamAData.interception && teamAData.interception.join('') !== '000' ? `
                  <div style="margin-top: 8px;">
                    <strong>Team A Interception:</strong> ${teamAData.interception.join(' ')} 
                    <span style="color: ${teamAIntercepted ? '#e53e3e' : '#38a169'}; font-weight: bold;">
                      ${teamAIntercepted ? '‚úì Success!' : '‚úó Failed'}
                    </span>
                  </div>
                ` : '<div style="margin-top: 8px;"><strong>Team A Interception:</strong> Skipped</div>'}
              </div>

            </div>
          </div>
        `;
      });

      html += '</div>';
      document.getElementById('historySection').innerHTML = html;
    }

    function toggleHistoryItem(index) {
      const details = document.getElementById(`details-${index}`);
      const icon = document.getElementById(`icon-${index}`);
      
      if (details.classList.contains('expanded')) {
        details.classList.remove('expanded');
        icon.classList.remove('rotated');
      } else {
        details.classList.add('expanded');
        icon.classList.add('rotated');
      }
    }

    function renderClueTracker() {
      const opponentTeam = myTeam === 'A' ? 'B' : 'A';
      const opponentTeamName = opponentTeam === 'A' ? 'Team A (Blue)' : 'Team B (Orange)';
      const teamClass = opponentTeam === 'A' ? 'team-a' : 'team-b';
      
      if (!currentGame?.rounds || currentGame.rounds.length === 0) {
        return '';
      }

      // Organize clues by number (1-4) from all past rounds
      const cluesByNumber = {
        1: [],
        2: [],
        3: [],
        4: []
      };

      // Go through completed rounds and collect opponent's clues
      currentGame.rounds.forEach(round => {
        const roundNum = round.round;
        const opponentData = opponentTeam === 'A' ? round.teamA : round.teamB;
        
        if (opponentData && opponentData.code && opponentData.clues) {
          // Map each clue to its corresponding number
          opponentData.code.forEach((number, index) => {
            cluesByNumber[number].push({
              round: roundNum,
              clue: opponentData.clues[index]
            });
          });
        }
      });

      // Add current round's clues if they exist
      const currentOpponentData = currentGame.roundData?.[opponentTeam];
      if (currentOpponentData?.code && currentOpponentData?.clues && currentGame.phase !== 'clues') {
        currentOpponentData.code.forEach((number, index) => {
          cluesByNumber[number].push({
            round: currentGame.currentRound,
            clue: currentOpponentData.clues[index],
            isCurrent: true
          });
        });
      }

      let html = `
        <div class="card ${teamClass}">
          <h2>üìù ${opponentTeamName} Clue Tracker</h2>
          <p style="color: #718096; margin-bottom: 10px;">Track their clues by word number to help with interceptions!</p>
          <div class="clue-tracker-grid">
      `;

      // Render columns for each number
      for (let num = 1; num <= 4; num++) {
        html += `
          <div class="clue-column">
            <div class="clue-column-header">Word #${num}</div>
        `;
        
        if (cluesByNumber[num].length === 0) {
          html += '<div style="text-align: center; color: #a0aec0; padding: 20px;">No clues yet</div>';
        } else {
          cluesByNumber[num].forEach(entry => {
            const highlightClass = entry.isCurrent ? 'round-highlight' : '';
            html += `
              <div class="clue-entry ${highlightClass}">
                <span class="clue-entry-round">R${entry.round}:</span>
                ${entry.clue}
              </div>
            `;
          });
        }
        
        html += '</div>';
      }

      html += `
          </div>
        </div>
      `;

      return html;
    }
  </script>
</body>
</html>
