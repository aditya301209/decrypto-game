<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Decrypto - Remote Multiplayer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }

    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 2.5em;
    }

    h2 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.8em;
    }

    h3 {
      color: #764ba2;
      margin-bottom: 10px;
      font-size: 1.3em;
    }

    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
      margin-right: 10px;
      margin-top: 10px;
    }

    .btn:hover {
      background: #764ba2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .btn-secondary {
      background: #48bb78;
    }

    .btn-secondary:hover {
      background: #38a169;
    }

    .btn-danger {
      background: #f56565;
    }

    .btn-danger:hover {
      background: #e53e3e;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      font-size: 16px;
      margin-bottom: 15px;
      transition: border 0.3s;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .team-a {
      background: #ebf8ff;
      border-left: 4px solid #3182ce;
    }

    .team-b {
      background: #fef5e7;
      border-left: 4px solid #dd6b20;
    }

    .words-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin: 20px 0;
    }

    .word-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .word-card .number {
      color: #667eea;
      font-size: 0.9em;
      margin-bottom: 5px;
    }

    .code-display {
      background: #fef5e7;
      border: 3px dashed #dd6b20;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      font-size: 3em;
      font-weight: bold;
      color: #dd6b20;
      letter-spacing: 20px;
      margin: 20px 0;
    }

    .hidden-code {
      background: #e2e8f0;
      border: 3px dashed #a0aec0;
      color: #a0aec0;
      cursor: not-allowed;
    }

    .clue-input-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 15px;
      align-items: center;
      margin: 10px 0;
    }

    .clue-label {
      font-weight: bold;
      color: #667eea;
      font-size: 1.2em;
    }

    .history-item {
      background: #f7fafc;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
    }

    .round-header {
      font-weight: bold;
      color: #667eea;
      margin-bottom: 8px;
    }

    .score-display {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .score-item {
      text-align: center;
      padding: 20px;
      background: #f7fafc;
      border-radius: 8px;
      flex: 1;
      margin: 10px;
      min-width: 150px;
    }

    .score-value {
      font-size: 3em;
      font-weight: bold;
      color: #667eea;
    }

    .score-label {
      font-size: 0.9em;
      color: #718096;
      margin-top: 5px;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .alert-success {
      background: #c6f6d5;
      color: #22543d;
      border-left: 4px solid #48bb78;
    }

    .alert-error {
      background: #fed7d7;
      color: #742a2a;
      border-left: 4px solid #f56565;
    }

    .alert-info {
      background: #bee3f8;
      color: #2c5282;
      border-left: 4px solid #3182ce;
    }

    .alert-warning {
      background: #fef5e7;
      color: #744210;
      border-left: 4px solid #dd6b20;
    }

    .game-over {
      text-align: center;
      padding: 40px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border-radius: 12px;
      font-size: 2em;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-connected {
      background: #48bb78;
    }

    .status-disconnected {
      background: #f56565;
    }

    .code-input-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 15px 0;
    }

    .code-input-group input {
      width: 60px;
      height: 60px;
      text-align: center;
      font-size: 2em;
      font-weight: bold;
      margin: 0;
    }

    .setup-instructions {
      background: #e6fffa;
      border: 2px solid #81e6d9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .setup-instructions h3 {
      color: #234e52;
      margin-bottom: 10px;
    }

    @media (max-width: 768px) {
      .words-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      h1 {
        font-size: 1.8em;
      }

      .score-display {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>üîê Decrypto</h1>
      <p style="color: #718096; margin-bottom: 20px;">Crack the code, protect your secrets! <span id="connectionStatus"></span></p>
      
      <div id="firebaseSetupInfo" class="setup-instructions">
        <h3>üî• Firebase-Powered Real-Time Multiplayer</h3>
        <p style="margin-bottom: 10px;">This game uses Firebase for instant synchronization across all players. Updates happen automatically - no refresh needed!</p>
        <p style="font-size: 0.9em; color: #234e52;">
          <strong>Status:</strong> <span id="firebaseStatus">Connecting...</span>
        </p>
      </div>

      <div id="setupScreen">
        <h2>Game Setup</h2>
        
        <div style="margin-bottom: 30px;">
          <h3>Create New Game</h3>
          <button class="btn" onclick="createGame()">Create New Game</button>
        </div>

        <div>
          <h3>Join Existing Game</h3>
          <input type="text" id="gameCodeInput" placeholder="Enter game code">
          <select id="teamSelect">
            <option value="">Select Team</option>
            <option value="A">Team A (Blue)</option>
            <option value="B">Team B (Orange)</option>
          </select>
          <select id="roleSelect">
            <option value="">Select Role</option>
            <option value="guesser">Guesser</option>
            <option value="cluegiver">Clue-Giver</option>
          </select>
          <button class="btn btn-secondary" onclick="joinGame()">Join Game</button>
        </div>
      </div>

      <div id="gameScreen" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
          <div>
            <h2 id="gameTitle">Game: <span id="gameCodeDisplay"></span></h2>
            <p id="playerInfo" style="color: #718096;"></p>
          </div>
          <div>
            <button class="btn btn-danger" onclick="leaveGame()">Leave Game</button>
          </div>
        </div>

        <div id="gameOverMessage" style="display: none;"></div>

        <div class="score-display">
          <div class="score-item team-a">
            <div class="score-value" id="teamAMiscomm">0</div>
            <div class="score-label">Team A Miscommunications</div>
          </div>
          <div class="score-item team-b">
            <div class="score-value" id="teamBMiscomm">0</div>
            <div class="score-label">Team B Miscommunications</div>
          </div>
          <div class="score-item team-a">
            <div class="score-value" id="teamAInterceptions">0</div>
            <div class="score-label">Team A Interceptions</div>
          </div>
          <div class="score-item team-b">
            <div class="score-value" id="teamBInterceptions">0</div>
            <div class="score-label">Team B Interceptions</div>
          </div>
        </div>

        <div id="myTeamSection"></div>
        <div id="opponentSection"></div>
        <div id="actionSection"></div>
        <div id="historySection"></div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script>
    // ============================================
    // FIREBASE CONFIG
    // ============================================
    const firebaseConfig = {
      apiKey: "AIzaSyBQfDW3cv268JlQRL7UeFhphR76hAStmS0",
      authDomain: "mydecrypto-2cc47.firebaseapp.com",
      databaseURL: "https://mydecrypto-2cc47-default-rtdb.firebaseio.com",
      projectId: "mydecrypto-2cc47",
      storageBucket: "mydecrypto-2cc47.firebasestorage.app",
      messagingSenderId: "757533875276",
      appId: "1:757533875276:web:28d3a9c5b8a9f5d5ec68e9",
      measurementId: "G-K4P1KKFH89"
    };
    // ============================================

    // Initialize Firebase
    let db = null;
    let isFirebaseConfigured = false;

    function updateConnectionStatus(connected, message = '') {
      const statusEl = document.getElementById('connectionStatus');
      const firebaseStatus = document.getElementById('firebaseStatus');
      
      if (connected) {
        statusEl.innerHTML = '<span class="status-indicator status-connected"></span>Connected';
        firebaseStatus.innerHTML = '<span style="color: #38a169;">‚úì Connected to Firebase</span>';
        document.getElementById('firebaseSetupInfo').style.background = '#c6f6d5';
        document.getElementById('firebaseSetupInfo').style.borderColor = '#48bb78';
      } else {
        statusEl.innerHTML = '<span class="status-indicator status-disconnected"></span>' + (message || 'Not Connected');
        firebaseStatus.innerHTML = '<span style="color: #c53030;">‚úó ' + (message || 'Not Connected') + '</span>';
        document.getElementById('firebaseSetupInfo').style.background = '#fed7d7';
        document.getElementById('firebaseSetupInfo').style.borderColor = '#fc8181';
      }
    }

    function initializeFirebase() {
      console.log('üî• Initializing Firebase...');
      
      // Check if Firebase SDK loaded
      if (typeof firebase === 'undefined') {
        console.error('‚ùå Firebase SDK not loaded');
        updateConnectionStatus(false, 'Firebase SDK failed to load');
        return;
      }

      console.log('‚úì Firebase SDK loaded');

      try {
        if (!firebaseConfig.databaseURL || firebaseConfig.databaseURL.includes('YOUR_PROJECT')) {
          console.error('‚ùå Missing databaseURL');
          updateConnectionStatus(false, 'Missing database URL');
        } else {
          console.log('‚úì Initializing with config...');
          firebase.initializeApp(firebaseConfig);
          db = firebase.database();
          
          // Test connection
          db.ref('.info/connected').on('value', (snapshot) => {
            if (snapshot.val() === true) {
              console.log('‚úÖ Connected to Firebase!');
              isFirebaseConfigured = true;
              updateConnectionStatus(true);
            } else {
              console.log('‚ö†Ô∏è Connecting...');
              updateConnectionStatus(false, 'Connecting...');
            }
          });
        }
      } catch (error) {
        console.error('‚ùå Firebase error:', error);
        updateConnectionStatus(false, 'Initialization failed');
      }
    }

    // Wait for page to load
    window.addEventListener('load', initializeFirebase);

    // Game state
    let currentGame = null;
    let myTeam = null;
    let myRole = null;
    let gameCode = null;
    let gameRef = null;

    const WORD_BANK = [
      "PIANO", "THUNDER", "DIAMOND", "CASTLE", "ROBOT", "OCEAN", "ROCKET", "DRAGON",
      "MAGIC", "FOREST", "CLOCK", "MIRROR", "BOOK", "STAR", "MOON", "FIRE",
      "WATER", "EARTH", "WIND", "MOUNTAIN", "RIVER", "BRIDGE", "TOWER", "CROWN",
      "SWORD", "SHIELD", "ARROW", "GATE", "WALL", "PATH", "ROAD", "SHIP",
      "COIN", "RING", "KEY", "LOCK", "DOOR", "WINDOW", "LIGHT", "SHADOW",
      "CLOUD", "RAIN", "SNOW", "SUN", "NIGHT", "DAY", "TIME", "SPACE",
      "HEART", "MIND", "SOUL", "DREAM", "HOPE", "FEAR", "JOY", "PEACE",
      "WAR", "KING", "QUEEN", "KNIGHT", "ANGEL", "DEMON", "GHOST", "SPIRIT"
    ];

    function generateGameCode() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function getRandomWords(count) {
      const shuffled = [...WORD_BANK].sort(() => Math.random() - 0.5);
      return shuffled.slice(0, count);
    }

    function generateCode() {
      return [
        Math.floor(Math.random() * 4) + 1,
        Math.floor(Math.random() * 4) + 1,
        Math.floor(Math.random() * 4) + 1
      ];
    }

    async function createGame() {
      if (!isFirebaseConfigured) {
        alert('Firebase is not connected yet. Please check the setup instructions.');
        return;
      }

      gameCode = generateGameCode();
      
      const newGame = {
        code: gameCode,
        teamA: {
          words: getRandomWords(4),
          score: { miscommunications: 0, interceptions: 0 }
        },
        teamB: {
          words: getRandomWords(4),
          score: { miscommunications: 0, interceptions: 0 }
        },
        rounds: [],
        currentRound: 1,
        currentTeam: 'A',
        gameOver: false,
        winner: null
      };

      try {
        await db.ref(`games/${gameCode}`).set(newGame);
        
        const setupScreen = document.getElementById('setupScreen');
        setupScreen.innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <h2 style="color: #48bb78; margin-bottom: 20px;">‚úì Game Created Successfully!</h2>
            <div style="background: #c6f6d5; padding: 30px; border-radius: 12px; margin: 20px 0;">
              <p style="font-size: 1.2em; margin-bottom: 10px; color: #22543d;">Share this code with your friends:</p>
              <div style="font-size: 3em; font-weight: bold; color: #22543d; letter-spacing: 8px;">${gameCode}</div>
            </div>
            <p style="color: #718096; margin: 20px 0;">Now join the game yourself:</p>
            <input type="text" id="gameCodeInput" value="${gameCode}" readonly style="background: #f7fafc;">
            <select id="teamSelect">
              <option value="">Select Team</option>
              <option value="A">Team A (Blue)</option>
              <option value="B">Team B (Orange)</option>
            </select>
            <select id="roleSelect">
              <option value="">Select Role</option>
              <option value="guesser">Guesser</option>
              <option value="cluegiver">Clue-Giver</option>
            </select>
            <button class="btn btn-secondary" onclick="joinGame()">Join Game</button>
            <button class="btn" onclick="location.reload()">Create Different Game</button>
          </div>
        `;
      } catch (error) {
        console.error('Error creating game:', error);
        alert('Error creating game: ' + error.message);
      }
    }

    async function joinGame() {
      console.log('=== JOIN GAME DEBUG ===');
      
      if (!isFirebaseConfigured) {
        alert('Firebase is not connected yet. Please wait or check the setup.');
        return;
      }

      const code = document.getElementById('gameCodeInput').value.trim().toUpperCase();
      const team = document.getElementById('teamSelect').value;
      const role = document.getElementById('roleSelect').value;

      console.log('Attempting to join:', { code, team, role });

      if (!code || !team || !role) {
        alert('Please fill in all fields');
        return;
      }

      try {
        gameCode = code;
        myTeam = team;
        myRole = role;
        gameRef = db.ref(`games/${gameCode}`);

        console.log('Fetching game data from Firebase...');
        const snapshot = await gameRef.once('value');
        
        if (!snapshot.exists()) {
          console.error('Game not found in database');
          alert('Game not found! Please check the code.');
          return;
        }

        currentGame = snapshot.val();
        console.log('Game data loaded:', currentGame);
        console.log('Current game structure check:', {
          hasTeamA: !!currentGame.teamA,
          hasTeamB: !!currentGame.teamB,
          hasRounds: !!currentGame.rounds,
          roundsLength: currentGame.rounds?.length,
          currentRound: currentGame.currentRound,
          currentTeam: currentGame.currentTeam
        });

        // Listen for real-time updates
        console.log('Setting up real-time listener...');
        gameRef.on('value', (snapshot) => {
          if (snapshot.exists()) {
            currentGame = snapshot.val();
            console.log('Game updated from Firebase');
            try {
              renderGame();
            } catch (error) {
              console.error('Error in renderGame:', error);
              console.error('Stack trace:', error.stack);
            }
          }
        });

        console.log('Switching to game screen...');
        document.getElementById('setupScreen').style.display = 'none';
        document.getElementById('gameScreen').style.display = 'block';
        
        console.log('Calling initial renderGame...');
        try {
          renderGame();
        } catch (error) {
          console.error('Error in initial renderGame:', error);
          console.error('Stack trace:', error.stack);
          alert('Error rendering game: ' + error.message);
        }
        
        console.log('=== JOIN COMPLETE ===');
      } catch (error) {
        console.error('Error joining game:', error);
        console.error('Stack trace:', error.stack);
        alert('Error joining game: ' + error.message);
      }
    }

    function leaveGame() {
      if (confirm('Are you sure you want to leave the game?')) {
        if (gameRef) {
          gameRef.off();
        }
        location.reload();
      }
    }

    function renderGame() {
      console.log('renderGame called');
      
      if (!currentGame) {
        console.error('renderGame called but currentGame is null');
        return;
      }

      console.log('Rendering game with data:', {
        gameCode,
        myTeam,
        myRole,
        currentRound: currentGame.currentRound,
        roundsCount: currentGame.rounds?.length
      });

      try {
        document.getElementById('gameCodeDisplay').textContent = gameCode;
        document.getElementById('playerInfo').textContent = 
          `You are: Team ${myTeam} - ${myRole === 'cluegiver' ? 'Clue-Giver' : 'Guesser'} | Round ${currentGame.currentRound}`;

        document.getElementById('teamAMiscomm').textContent = currentGame.teamA?.score?.miscommunications || 0;
        document.getElementById('teamBMiscomm').textContent = currentGame.teamB?.score?.miscommunications || 0;
        document.getElementById('teamAInterceptions').textContent = currentGame.teamA?.score?.interceptions || 0;
        document.getElementById('teamBInterceptions').textContent = currentGame.teamB?.score?.interceptions || 0;

        if (currentGame.gameOver) {
          document.getElementById('gameOverMessage').style.display = 'block';
          document.getElementById('gameOverMessage').innerHTML = `
            <div class="game-over">
              üéâ Game Over! ${currentGame.winner} wins! üéâ
            </div>
          `;
        }

        console.log('Calling renderMyTeamSection...');
        renderMyTeamSection();
        
        console.log('Calling renderOpponentSection...');
        renderOpponentSection();
        
        console.log('Calling renderActionSection...');
        renderActionSection();
        
        console.log('Calling renderHistory...');
        renderHistory();
        
        console.log('renderGame completed successfully');
      } catch (error) {
        console.error('Error in renderGame:', error);
        console.error('Stack trace:', error.stack);
        throw error;
      }
    }

    function renderMyTeamSection() {
      if (!currentGame) {
        console.error('renderMyTeamSection called but currentGame is null');
        return;
      }

      const myTeamData = myTeam === 'A' ? currentGame.teamA : currentGame.teamB;
      
      if (!myTeamData || !myTeamData.words) {
        console.error('Team data or words missing');
        document.getElementById('myTeamSection').innerHTML = '<div class="card"><p>Loading team data...</p></div>';
        return;
      }

      const teamClass = myTeam === 'A' ? 'team-a' : 'team-b';
      
      const html = `
        <div class="card ${teamClass}">
          <h2>Your Team (Team ${myTeam}) - Secret Words</h2>
          <div class="words-grid">
            ${myTeamData.words.map((word, idx) => `
              <div class="word-card">
                <div class="number">#${idx + 1}</div>
                <div>${word}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      
      document.getElementById('myTeamSection').innerHTML = html;
    }

    function renderOpponentSection() {
      const opponentTeam = myTeam === 'A' ? 'B' : 'A';
      const teamClass = opponentTeam === 'A' ? 'team-a' : 'team-b';
      
      const html = `
        <div class="card ${teamClass}">
          <h2>Opponent Team (Team ${opponentTeam})</h2>
          <p style="color: #718096;">You can see their clues in the history, but not their secret words!</p>
        </div>
      `;
      
      document.getElementById('opponentSection').innerHTML = html;
    }

    function renderActionSection() {
      if (!currentGame) {
        console.error('renderActionSection called but currentGame is null');
        document.getElementById('actionSection').innerHTML = '<div class="card"><p>Loading game...</p></div>';
        return;
      }

      const currentRound = currentGame.rounds?.[currentGame.currentRound - 1];
      const isMyTeamsTurn = currentGame.currentTeam === myTeam;
      
      let html = '<div class="card">';

      if (currentGame.gameOver) {
        html += '<p style="text-align: center; font-size: 1.2em; color: #718096;">Game is over!</p>';
      } else if (isMyTeamsTurn && myRole === 'cluegiver' && (!currentRound || !currentRound?.clues)) {
        const code = generateCode();
        html += `
          <h2>Your Turn - Give Clues</h2>
          <div class="code-display">${code.join(' ')}</div>
          <p style="margin-bottom: 15px; color: #718096;">Give one clue for each number. Help your team identify which word corresponds to each number.</p>
          ${code.map((num, idx) => `
            <div class="clue-input-grid">
              <div class="clue-label">Clue for #${num}:</div>
              <input type="text" id="clue${idx}" placeholder="Enter your clue">
            </div>
          `).join('')}
          <button class="btn" onclick="submitClues([${code}])">Submit Clues</button>
        `;
      } else if (isMyTeamsTurn && myRole === 'guesser' && currentRound?.clues && Array.isArray(currentRound.clues) && currentRound.clues.length >= 3 && !currentRound?.guess) {
        html += `
          <h2>Your Turn - Guess the Code</h2>
          <div class="alert alert-info">
            <strong>Clues:</strong><br>
            Clue 1: ${currentRound.clues[0] || 'No clue'}<br>
            Clue 2: ${currentRound.clues[1] || 'No clue'}<br>
            Clue 3: ${currentRound.clues[2] || 'No clue'}
          </div>
          <div class="code-input-group">
            <input type="number" id="guess0" min="1" max="4" placeholder="1">
            <input type="number" id="guess1" min="1" max="4" placeholder="2">
            <input type="number" id="guess2" min="1" max="4" placeholder="3">
          </div>
          <button class="btn" onclick="submitGuess()">Submit Guess</button>
        `;
      } else if (!isMyTeamsTurn && currentRound?.clues && Array.isArray(currentRound.clues) && currentRound.clues.length >= 3 && !currentRound?.interception) {
        html += `
          <h2>Opponent's Turn - Attempt Interception</h2>
          <div class="alert alert-info">
            <strong>Opponent's Clues:</strong><br>
            Clue 1: ${currentRound.clues[0] || 'No clue'}<br>
            Clue 2: ${currentRound.clues[1] || 'No clue'}<br>
            Clue 3: ${currentRound.clues[2] || 'No clue'}
          </div>
          <div class="code-input-group">
            <input type="number" id="intercept0" min="1" max="4" placeholder="1">
            <input type="number" id="intercept1" min="1" max="4" placeholder="2">
            <input type="number" id="intercept2" min="1" max="4" placeholder="3">
          </div>
          <button class="btn" onclick="submitInterception()">Attempt Interception</button>
          <button class="btn btn-secondary" onclick="skipInterception()">Skip</button>
        `;
      } else {
        html += '<p style="text-align: center; color: #718096;">Waiting for other players...</p>';
      }

      html += '</div>';
      document.getElementById('actionSection').innerHTML = html;
    }

    async function submitClues(code) {
      const clues = [
        document.getElementById('clue0').value.trim(),
        document.getElementById('clue1').value.trim(),
        document.getElementById('clue2').value.trim()
      ];

      if (clues.some(c => !c)) {
        alert('Please enter all three clues');
        return;
      }

      const round = {
        roundNumber: currentGame.currentRound,
        team: myTeam,
        code: code,
        clues: clues,
        guess: null,
        guessCorrect: null,
        interception: null,
        interceptionCorrect: null
      };

      currentGame.rounds[currentGame.currentRound - 1] = round;

      try {
        await gameRef.set(currentGame);
        alert('Clues submitted!');
      } catch (error) {
        console.error('Error:', error);
        alert('Error submitting clues');
      }
    }

    async function submitGuess() {
      const guess = [
        parseInt(document.getElementById('guess0').value),
        parseInt(document.getElementById('guess1').value),
        parseInt(document.getElementById('guess2').value)
      ];

      if (guess.some(g => !g || g < 1 || g > 4)) {
        alert('Please enter valid numbers (1-4)');
        return;
      }

      const currentRound = currentGame.rounds?.[currentGame.currentRound - 1];
      if (!currentRound || !currentRound.code) {
        alert('Error: Round data not found');
        console.error('Current round missing or invalid:', currentRound);
        return;
      }

      const correct = JSON.stringify(guess) === JSON.stringify(currentRound.code);
      
      currentRound.guess = guess;
      currentRound.guessCorrect = correct;

      if (!correct) {
        const teamKey = `team${myTeam}`;
        currentGame[teamKey].score.miscommunications++;
        
        if (currentGame[teamKey].score.miscommunications >= 2) {
          currentGame.gameOver = true;
          currentGame.winner = `Team ${myTeam === 'A' ? 'B' : 'A'}`;
        }
      }

      try {
        await gameRef.set(currentGame);
        alert(correct ? 'Correct! ‚úì' : `Incorrect. Code was: ${currentRound.code.join(' ')}`);
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function submitInterception() {
      const interception = [
        parseInt(document.getElementById('intercept0').value),
        parseInt(document.getElementById('intercept1').value),
        parseInt(document.getElementById('intercept2').value)
      ];

      if (interception.some(g => !g || g < 1 || g > 4)) {
        alert('Please enter valid numbers (1-4)');
        return;
      }

      const currentRound = currentGame.rounds?.[currentGame.currentRound - 1];
      if (!currentRound || !currentRound.code) {
        alert('Error: Round data not found');
        console.error('Current round missing or invalid:', currentRound);
        return;
      }

      const correct = JSON.stringify(interception) === JSON.stringify(currentRound.code);
      
      currentRound.interception = interception;
      currentRound.interceptionCorrect = correct;

      if (correct) {
        const teamKey = `team${myTeam}`;
        currentGame[teamKey].score.interceptions++;
        
        if (currentGame[teamKey].score.interceptions >= 2) {
          currentGame.gameOver = true;
          currentGame.winner = `Team ${myTeam}`;
        }
      }

      advanceRound();

      try {
        await gameRef.set(currentGame);
        alert(correct ? 'Interception successful! ‚úì' : 'Interception failed.');
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function skipInterception() {
      const currentRound = currentGame.rounds?.[currentGame.currentRound - 1];
      if (!currentRound) {
        alert('Error: Round data not found');
        console.error('Current round missing');
        return;
      }

      currentRound.interception = null;
      currentRound.interceptionCorrect = false;

      advanceRound();

      try {
        await gameRef.set(currentGame);
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function advanceRound() {
      if (!currentGame.gameOver) {
        currentGame.currentRound++;
        currentGame.currentTeam = currentGame.currentTeam === 'A' ? 'B' : 'A';
      }
    }

    function renderHistory() {
      if (!currentGame || !currentGame.rounds || currentGame.rounds.length === 0) {
        document.getElementById('historySection').innerHTML = '';
        return;
      }

      let html = '<div class="card"><h2>Game History</h2>';

      currentGame.rounds.forEach(round => {
        if (!round || !round.clues) return;

        const teamClass = round.team === 'A' ? 'team-a' : 'team-b';
        html += `
          <div class="history-item ${teamClass}">
            <div class="round-header">Round ${round.roundNumber} - Team ${round.team}</div>
            <div><strong>Code:</strong> ${round.code.join(' ')}</div>
            <div><strong>Clues:</strong> ${round.clues.join(' | ')}</div>
            ${round.guess ? `<div><strong>Team Guess:</strong> ${round.guess.join(' ')} ${round.guessCorrect ? '‚úì' : '‚úó'}</div>` : ''}
            ${round.interception ? `<div><strong>Interception:</strong> ${round.interception.join(' ')} ${round.interceptionCorrect ? '‚úì' : '‚úó'}</div>` : ''}
          </div>
        `;
      });

      html += '</div>';
      document.getElementById('historySection').innerHTML = html;
    }
  </script>
</body>
</html>
